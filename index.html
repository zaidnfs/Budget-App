<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to the top for better scrolling on small screens */
            min-height: 100vh;
            padding: 2rem 1rem; /* Add padding for overall layout */
        }
        .container {
            background-color: #ffffff;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* Deeper shadow */
            padding: 2.5rem;
            max-width: 900px; /* Increased max-width */
            width: 100%;
            margin: auto; /* Center the container */
        }
        input[type="number"], input[type="text"] {
            border: 1px solid #cbd5e0; /* Light gray border */
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        input[type="number"]:focus, input[type="text"]:focus {
            outline: none;
            border-color: #3b82f6; /* Blue focus border */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); /* Light blue shadow on focus */
        }
        button {
            background-color: #4f46e5; /* Indigo button */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem; /* More rounded buttons */
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        button:hover {
            background-color: #4338ca; /* Darker indigo on hover */
            transform: translateY(-1px); /* Slight lift on hover */
        }
        button:active {
            transform: translateY(0);
            box-shadow: none;
        }
        .delete-btn {
            background-color: #ef4444; /* Red delete button */
            margin-left: 0.5rem;
            padding: 0.5rem 0.75rem;
        }
        .delete-btn:hover {
            background-color: #dc2626; /* Darker red on hover */
        }
        .summary-box {
            background-color: #e0f2fe; /* Light blue background for summary */
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 2rem;
            border: 1px solid #bfdbfe; /* Lighter blue border */
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #bfdbfe; /* Dashed border */
        }
        .summary-item:last-child {
            border-bottom: none;
        }
        .summary-item strong {
            color: #1e40af; /* Darker blue for labels */
        }
        .summary-item span {
            font-weight: 700;
            color: #000;
        }
        .remaining-balance {
            font-size: 1.5rem;
            font-weight: 800;
            color: #10b981; /* Green for positive balance */
        }
        .remaining-balance.negative {
            color: #ef4444; /* Red for negative balance */
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .variable-category-group {
            background-color: #ecfdf5; /* Lighter green for categories */
            border-radius: 0.75rem;
            border: 1px solid #a7f3d0; /* Green border */
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .category-name {
            font-weight: 600;
            color: #065f46; /* Darker green for category names */
        }
        .item-name, .item-amount {
            border: 1px solid #d1fae5; /* Even lighter green for item inputs */
        }
        .variable-category-group button {
            background-color: #10b981; /* Green button for adding items */
            color: white;
        }
        .variable-category-group button:hover {
            background-color: #059669; /* Darker green on hover */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-4xl font-extrabold text-center text-gray-800 mb-8">Budget Tracker</h1>

        <!-- Income Section -->
        <div class="mb-8 p-6 bg-blue-50 rounded-xl border border-blue-200">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">Your Income</h2>
            <label for="monthlyIncome" class="block text-gray-600 text-lg font-medium mb-2">Monthly Income (₹)</label>
            <input type="number" id="monthlyIncome" placeholder="e.g., 50000" class="mb-4">
        </div>

        <!-- Fixed Expenses Section -->
        <div class="mb-8 p-6 bg-purple-50 rounded-xl border border-purple-200">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">Fixed Expenses</h2>
            <div id="fixedExpensesContainer" class="space-y-4">
                <!-- Initial fixed expense input -->
                <div class="flex items-center space-x-2">
                    <input type="text" placeholder="Rent" class="expense-name flex-grow">
                    <input type="number" placeholder="Amount (₹)" class="expense-amount w-32">
                    <button type="button" class="delete-btn text-sm" onclick="removeGeneralExpenseRow(this)">X</button>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="text" placeholder="Internet" class="expense-name flex-grow">
                    <input type="number" placeholder="Amount (₹)" class="expense-amount w-32">
                    <button type="button" class="delete-btn text-sm" onclick="removeGeneralExpenseRow(this)">X</button>
                </div>
            </div>
            <button type="button" onclick="addGeneralExpenseRow('fixedExpensesContainer')" class="mt-6 px-4 py-2 text-sm">
                Add Fixed Expense
            </button>
        </div>

        <!-- Variable Expenses Section -->
        <div class="mb-8 p-6 bg-green-50 rounded-xl border border-green-200">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">Variable Expenses</h2>
            <div id="variableExpensesContainer" class="space-y-6">
                <!-- Example Category: Groceries -->
                <div class="variable-category-group">
                    <div class="flex items-center justify-between mb-3">
                        <input type="text" value="Groceries" placeholder="Category Name" class="category-name font-semibold text-lg flex-grow mr-2">
                        <button type="button" class="delete-btn text-sm rounded-full bg-red-500 hover:bg-red-600 text-white p-2 flex items-center justify-center w-8 h-8" onclick="removeVariableCategory(this)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="category-items space-y-2">
                        <div class="flex items-center space-x-2">
                            <input type="text" placeholder="Egg" class="item-name flex-grow">
                            <input type="number" placeholder="Amount (₹)" class="item-amount w-32">
                            <button type="button" class="delete-btn text-sm rounded-full bg-red-500 hover:bg-red-600 text-white p-2 flex items-center justify-center w-8 h-8" onclick="removeVariableItem(this)">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="text" placeholder="Banana" class="item-name flex-grow">
                            <input type="number" placeholder="Amount (₹)" class="item-amount w-32">
                            <button type="button" class="delete-btn text-sm rounded-full bg-red-500 hover:bg-red-600 text-white p-2 flex items-center justify-center w-8 h-8" onclick="removeVariableItem(this)">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button type="button" onclick="addVariableItemRow(this.closest('.variable-category-group'))" class="mt-4 px-4 py-2 text-sm">
                        Add Groceries Item
                    </button>
                </div>

                <!-- Example Category: Transportation -->
                <div class="variable-category-group">
                    <div class="flex items-center justify-between mb-3">
                        <input type="text" value="Transportation" placeholder="Category Name" class="category-name font-semibold text-lg flex-grow mr-2">
                        <button type="button" class="delete-btn text-sm rounded-full bg-red-500 hover:bg-red-600 text-white p-2 flex items-center justify-center w-8 h-8" onclick="removeVariableCategory(this)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <div class="category-items space-y-2">
                        <div class="flex items-center space-x-2">
                            <input type="text" placeholder="Bus Fare" class="item-name flex-grow">
                            <input type="number" placeholder="Amount (₹)" class="item-amount w-32">
                            <button type="button" class="delete-btn text-sm rounded-full bg-red-500 hover:bg-red-600 text-white p-2 flex items-center justify-center w-8 h-8" onclick="removeVariableItem(this)">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button type="button" onclick="addVariableItemRow(this.closest('.variable-category-group'))" class="mt-4 px-4 py-2 text-sm">
                        Add Transportation Item
                    </button>
                </div>
            </div>
            <button type="button" onclick="addVariableCategory()" class="mt-6 px-4 py-2 text-sm">
                Add New Variable Category
            </button>
        </div>

        <!-- Savings/Goals Section -->
        <div class="mb-8 p-6 bg-yellow-50 rounded-xl border border-yellow-200">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">Savings & Goals</h2>
            <div id="savingsContainer" class="space-y-4">
                <!-- Initial savings input -->
                <div class="flex items-center space-x-2">
                    <input type="text" placeholder="Emergency Fund" class="expense-name flex-grow">
                    <input type="number" placeholder="Amount (₹)" class="expense-amount w-32">
                    <button type="button" class="delete-btn text-sm" onclick="removeGeneralExpenseRow(this)">X</button>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="text" placeholder="Japan Relocation Fund" class="expense-name flex-grow">
                    <input type="number" placeholder="Amount (₹)" class="expense-amount w-32">
                    <button type="button" class="delete-btn text-sm" onclick="removeGeneralExpenseRow(this)">X</button>
                </div>
            </div>
            <button type="button" onclick="addGeneralExpenseRow('savingsContainer')" class="mt-6 px-4 py-2 text-sm">
                Add Savings Goal
            </button>
        </div>


        <!-- Calculate Button -->
        <div class="text-center mt-8">
            <button type="button" onclick="calculateBudget()">Calculate Budget</button>
        </div>

        <!-- Summary Section -->
        <div id="summary" class="summary-box hidden">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">Budget Summary</h2>
            <div class="summary-item">
                <strong>Total Income:</strong> <span id="totalIncomeSummary">₹0</span>
            </div>
            <div class="summary-item">
                <strong>Total Expenses:</strong> <span id="totalExpensesSummary">₹0</span>
            </div>
            <div class="summary-item">
                <strong>Total Savings:</strong> <span id="totalSavingsSummary">₹0</span>
            </div>
            <div class="summary-item !border-b-0 pt-4">
                <strong>Remaining Balance:</strong> <span id="remainingBalanceSummary" class="remaining-balance">₹0</span>
            </div>
            <div class="text-center mt-6">
                <button type="button" onclick="getBudgetInsights()" id="getInsightsBtn">
                    Get Budget Insights ✨
                    <span id="loadingSpinner" class="spinner hidden"></span>
                </button>
            </div>
        </div>

        <!-- AI Insights Section -->
        <div id="aiInsights" class="summary-box hidden">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">AI Budget Insights</h2>
            <div id="aiInsightsContent" class="text-gray-700 leading-relaxed">
                <!-- AI generated content will be displayed here -->
            </div>
        </div>
    </div>

    <script>
        /**
         * Adds a new general expense/savings input row to the specified container.
         * Used for Fixed Expenses and Savings Goals.
         * @param {string} containerId - The ID of the container (e.g., 'fixedExpensesContainer').
         */
        function addGeneralExpenseRow(containerId) {
            const container = document.getElementById(containerId);
            const newRow = document.createElement('div');
            newRow.className = 'flex items-center space-x-2';
            newRow.innerHTML = `
                <input type="text" placeholder="Expense Name" class="expense-name flex-grow rounded-md p-2 border border-gray-300">
                <input type="number" placeholder="Amount (₹)" class="expense-amount w-32 rounded-md p-2 border border-gray-300">
                <button type="button" class="delete-btn text-sm rounded-full bg-red-500 hover:bg-red-600 text-white p-2 flex items-center justify-center w-8 h-8" onclick="removeGeneralExpenseRow(this)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            `;
            container.appendChild(newRow);
        }

        /**
         * Removes a general expense/savings input row.
         * Used for Fixed Expenses and Savings Goals.
         * @param {HTMLElement} button - The delete button element that was clicked.
         */
        function removeGeneralExpenseRow(button) {
            button.closest('.flex.items-center.space-x-2').remove();
        }

        /**
         * Adds a new variable expense category group.
         */
        function addVariableCategory() {
            const container = document.getElementById('variableExpensesContainer');
            const newCategoryGroup = document.createElement('div');
            newCategoryGroup.className = 'variable-category-group';
            newCategoryGroup.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <input type="text" placeholder="New Category Name" class="category-name font-semibold text-lg flex-grow mr-2 rounded-md p-2 border border-gray-300">
                    <button type="button" class="delete-btn text-sm rounded-full bg-red-500 hover:bg-red-600 text-white p-2 flex items-center justify-center w-8 h-8" onclick="removeVariableCategory(this)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="category-items space-y-2">
                    <!-- Initial item for the new category -->
                    <div class="flex items-center space-x-2">
                        <input type="text" placeholder="Item Name" class="item-name flex-grow rounded-md p-2 border border-gray-300">
                        <input type="number" placeholder="Amount (₹)" class="item-amount w-32 rounded-md p-2 border border-gray-300">
                        <button type="button" class="delete-btn text-sm rounded-full bg-red-500 hover:bg-red-600 text-white p-2 flex items-center justify-center w-8 h-8" onclick="removeVariableItem(this)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
                <button type="button" onclick="addVariableItemRow(this.closest('.variable-category-group'))" class="mt-4 px-4 py-2 text-sm bg-green-600 hover:bg-green-700 text-white rounded-lg">
                    Add Item to Category
                </button>
            `;
            container.appendChild(newCategoryGroup);
        }

        /**
         * Adds a new item input row within a specific variable expense category.
         * @param {HTMLElement} categoryGroupDiv - The div element representing the variable category group.
         */
        function addVariableItemRow(categoryGroupDiv) {
            const categoryItemsContainer = categoryGroupDiv.querySelector('.category-items');
            const newItemRow = document.createElement('div');
            newItemRow.className = 'flex items-center space-x-2';
            newItemRow.innerHTML = `
                <input type="text" placeholder="Item Name" class="item-name flex-grow rounded-md p-2 border border-gray-300">
                <input type="number" placeholder="Amount (₹)" class="item-amount w-32 rounded-md p-2 border border-gray-300">
                <button type="button" class="delete-btn text-sm rounded-full bg-red-500 hover:bg-red-600 text-white p-2 flex items-center justify-center w-8 h-8" onclick="removeVariableItem(this)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            `;
            categoryItemsContainer.appendChild(newItemRow);
        }

        /**
         * Removes an individual item row from a variable expense category.
         * @param {HTMLElement} button - The delete button element that was clicked.
         */
        function removeVariableItem(button) {
            button.closest('.flex.items-center.space-x-2').remove();
        }

        /**
         * Removes an entire variable expense category group.
         * @param {HTMLElement} button - The delete button element that was clicked.
         */
        function removeVariableCategory(button) {
            button.closest('.variable-category-group').remove();
        }

        /**
         * Calculates the total expenses from a given container.
         * This function is now smart enough to handle both general expenses and nested variable expenses.
         * @param {string} containerId - The ID of the container holding expense inputs.
         * @returns {number} The total sum of expenses in that container.
         */
        function getTotalFromContainer(containerId) {
            const container = document.getElementById(containerId);
            let total = 0;

            if (containerId === 'variableExpensesContainer') {
                // For variable expenses, iterate through categories and then items within each category
                const categoryGroups = container.querySelectorAll('.variable-category-group');
                categoryGroups.forEach(categoryGroup => {
                    const itemAmounts = categoryGroup.querySelectorAll('.item-amount');
                    itemAmounts.forEach(input => {
                        const value = parseFloat(input.value);
                        if (!isNaN(value) && value > 0) {
                            total += value;
                        }
                    });
                });
            } else {
                // For fixed expenses and savings, use the existing logic
                const amountInputs = container.querySelectorAll('.expense-amount');
                amountInputs.forEach(input => {
                    const value = parseFloat(input.value);
                    if (!isNaN(value) && value > 0) {
                        total += value;
                    }
                });
            }
            return total;
        }

        /**
         * Gathers expense details (name and amount) from a given container.
         * This function is updated to handle the nested structure of variable expenses.
         * @param {string} containerId - The ID of the container holding expense inputs.
         * @returns {Array<Object>} An array of objects, each with 'name' and 'amount' for general expenses,
         * or 'category' and 'items' for variable expenses.
         */
        function getExpenseDetailsFromContainer(containerId) {
            const container = document.getElementById(containerId);
            const details = [];

            if (containerId === 'variableExpensesContainer') {
                const categoryGroups = container.querySelectorAll('.variable-category-group');
                categoryGroups.forEach(categoryGroup => {
                    const categoryNameInput = categoryGroup.querySelector('.category-name');
                    const categoryName = categoryNameInput ? categoryNameInput.value.trim() : 'Unnamed Category';
                    const itemRows = categoryGroup.querySelectorAll('.flex.items-center.space-x-2');
                    const items = [];
                    itemRows.forEach(row => {
                        const itemNameInput = row.querySelector('.item-name');
                        const itemAmountInput = row.querySelector('.item-amount');
                        const itemName = itemNameInput.value.trim();
                        const itemAmount = parseFloat(itemAmountInput.value);
                        if (itemName && !isNaN(itemAmount) && itemAmount > 0) {
                            items.push({ name: itemName, amount: itemAmount });
                        }
                    });
                    if (items.length > 0) {
                        details.push({ category: categoryName, items: items });
                    }
                });
            } else {
                // Existing logic for fixed expenses and savings
                const expenseRows = container.querySelectorAll('.flex.items-center.space-x-2');
                expenseRows.forEach(row => {
                    const nameInput = row.querySelector('.expense-name');
                    const amountInput = row.querySelector('.expense-amount');
                    const name = nameInput.value.trim();
                    const amount = parseFloat(amountInput.value);
                    if (name && !isNaN(amount) && amount > 0) {
                        details.push({ name: name, amount: amount });
                    }
                });
            }
            return details;
        }

        /**
         * Calculates and displays the budget summary.
         */
        function calculateBudget() {
            const monthlyIncome = parseFloat(document.getElementById('monthlyIncome').value) || 0;

            const totalFixedExpenses = getTotalFromContainer('fixedExpensesContainer');
            const totalVariableExpenses = getTotalFromContainer('variableExpensesContainer');
            const totalSavings = getTotalFromContainer('savingsContainer');

            const totalExpenses = totalFixedExpenses + totalVariableExpenses;
            const remainingBalance = monthlyIncome - totalExpenses - totalSavings;

            // Display results
            document.getElementById('totalIncomeSummary').textContent = `₹${monthlyIncome.toLocaleString('en-IN')}`;
            document.getElementById('totalExpensesSummary').textContent = `₹${totalExpenses.toLocaleString('en-IN')}`;
            document.getElementById('totalSavingsSummary').textContent = `₹${totalSavings.toLocaleString('en-IN')}`;

            const remainingBalanceElement = document.getElementById('remainingBalanceSummary');
            remainingBalanceElement.textContent = `₹${remainingBalance.toLocaleString('en-IN')}`;
            // Apply color based on positive/negative balance
            if (remainingBalance < 0) {
                remainingBalanceElement.classList.add('negative');
            } else {
                remainingBalanceElement.classList.remove('negative');
            }

            // Show the summary section
            document.getElementById('summary').classList.remove('hidden');
            document.getElementById('aiInsights').classList.add('hidden'); // Hide insights when recalculating
        }

        /**
         * Calls the Gemini API to get budget insights.
         */
        async function getBudgetInsights() {
            const monthlyIncome = parseFloat(document.getElementById('monthlyIncome').value) || 0;

            const fixedExpenses = getExpenseDetailsFromContainer('fixedExpensesContainer');
            const variableExpenses = getExpenseDetailsFromContainer('variableExpensesContainer'); // This now returns categories and items
            const savingsGoals = getExpenseDetailsFromContainer('savingsContainer');

            // Check if income is entered and at least one expense/saving is present
            if (monthlyIncome <= 0 && fixedExpenses.length === 0 && variableExpenses.length === 0 && savingsGoals.length === 0) {
                document.getElementById('aiInsightsContent').textContent = "Please enter your income and some expenses/savings to get insights.";
                document.getElementById('aiInsights').classList.remove('hidden');
                return;
            }

            const getInsightsBtn = document.getElementById('getInsightsBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const aiInsightsContent = document.getElementById('aiInsightsContent');
            const aiInsightsSection = document.getElementById('aiInsights');

            getInsightsBtn.disabled = true;
            loadingSpinner.classList.remove('hidden');
            aiInsightsContent.textContent = 'Generating insights...';
            aiInsightsSection.classList.remove('hidden');

            // Format fixed expenses for the prompt
            let fixedExpensesText = fixedExpenses.map(e => `${e.name}: ₹${e.amount.toLocaleString('en-IN')}`).join('\n');
            if (fixedExpensesText === "") fixedExpensesText = "None";

            // Format variable expenses for the prompt, including categories and items
            let variableExpensesText = '';
            if (variableExpenses.length > 0) {
                variableExpenses.forEach(category => {
                    variableExpensesText += `  ${category.category}:\n`;
                    if (category.items.length > 0) {
                        category.items.forEach(item => {
                            variableExpensesText += `    - ${item.name}: ₹${item.amount.toLocaleString('en-IN')}\n`;
                        });
                    } else {
                        variableExpensesText += `    (No items in this category)\n`;
                    }
                });
            } else {
                variableExpensesText = "None";
            }

            // Format savings goals for the prompt
            let savingsGoalsText = savingsGoals.map(e => `${e.name}: ₹${e.amount.toLocaleString('en-IN')}`).join('\n');
            if (savingsGoalsText === "") savingsGoalsText = "None";

            const prompt = `I am creating a personal budget. Here is my current financial breakdown:
            Monthly Income: ₹${monthlyIncome.toLocaleString('en-IN')}

            Fixed Expenses:
            ${fixedExpensesText}

            Variable Expenses:
            ${variableExpensesText}

            Savings Goals:
            ${savingsGoalsText}

            Please analyze this budget. Provide actionable advice on how I can better manage my money, identify potential areas for saving, and offer general financial tips. Also, give a brief breakdown of my spending percentages across fixed, variable, and savings categories relative to my total income. Keep the response concise, easy to understand, and formatted with clear headings or bullet points.`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; // If you want to use models other than gemini-2.5-flash-preview-05-20 or imagen-3.0-generate-002, provide an API key here. Otherwise, leave this as-is.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let retries = 0;
            const maxRetries = 3;
            const initialDelay = 1000; // 1 second

            while (retries < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && retries < maxRetries - 1) { // Too Many Requests
                            const delay = initialDelay * Math.pow(2, retries);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            retries++;
                            continue;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content[0].parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        aiInsightsContent.innerHTML = text.replace(/\n/g, '<br>'); // Display newlines as breaks
                    } else {
                        aiInsightsContent.textContent = "Sorry, I couldn't generate insights. Please try again.";
                    }
                    break; // Exit loop on success
                } catch (error) {
                    console.error('Error fetching AI insights:', error);
                    aiInsightsContent.textContent = "An error occurred while fetching insights. Please try again.";
                    break; // Exit loop on unrecoverable error
                } finally {
                    getInsightsBtn.disabled = false;
                    loadingSpinner.classList.add('hidden');
                }
            }
        }
    </script>
</body>
</html>
